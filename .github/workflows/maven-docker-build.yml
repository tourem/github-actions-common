name: Maven Docker Build - Reusable Workflow

on:
  workflow_call:
    inputs:
      # Configuration Maven
      java-version:
        description: 'Java version (e.g., 17, 21)'
        required: true
        type: string
      
      maven-version:
        description: 'Maven version (e.g., 3.9)'
        required: false
        type: string
        default: '3.9'
      
      maven-pom:
        description: 'Path to pom.xml'
        required: false
        type: string
        default: 'pom.xml'
      
      # Configuration Dockerfile
      dockerfile-repo:
        description: 'Repository containing Dockerfile (e.g., owner/repo)'
        required: true
        type: string
      
      dockerfile-branch:
        description: 'Branch of Dockerfile repository'
        required: false
        type: string
        default: 'main'
      
      # Configuration Docker Builds
      docker-modules:
        description: 'JSON array of modules to build (name, artifact, config). If empty, auto-detect from pom.xml'
        required: false
        type: string
        default: ''

      environment:
        description: 'Deployment environment (dev, hml, prd) - used for auto-detection'
        required: false
        type: string
        default: 'dev'
      
      # Options
      skip-tests:
        description: 'Skip Maven tests'
        required: false
        type: boolean
        default: false
      
      docker-build-enabled:
        description: 'Enable Docker build and push'
        required: false
        type: boolean
        default: true
      
      deployment-descriptors-enabled:
        description: 'Enable deployment descriptors generation'
        required: false
        type: boolean
        default: true
      

      
      maven-registry:
        description: 'Maven registry URL (auto-detected if not provided)'
        required: false
        type: string
        default: ''
      
      docker-registry:
        description: 'Docker registry URL (auto-detected if not provided)'
        required: false
        type: string
        default: ''

    outputs:
      version:
        description: 'Maven project version'
        value: ${{ jobs.build-and-publish.outputs.version }}
      
      docker-images:
        description: 'List of Docker images built'
        value: ${{ jobs.build-docker-images.outputs.images }}

jobs:
  detect-modules:
    name: Auto-Detect Modules
    runs-on: ubuntu-latest

    outputs:
      modules: ${{ steps.build-json.outputs.modules }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install jq
        run: |
          # jq est g√©n√©ralement d√©j√† install√© sur les runners Ubuntu
          if ! command -v jq &> /dev/null; then
            sudo apt-get update && sudo apt-get install -y jq
          fi

      - name: Detect modules from pom.xml
        id: detect
        run: |
          echo "üîç D√©tection des modules Maven..."

          # Extraire le groupId du projet (en ignorant le bloc parent)
          GROUP_ID=""
          in_parent=false
          while IFS= read -r line; do
            if [[ "$line" =~ \<parent\> ]]; then
              in_parent=true
            elif [[ "$line" =~ \</parent\> ]]; then
              in_parent=false
            elif [[ "$line" =~ \<groupId\>(.*)\</groupId\> ]] && [ "$in_parent" = false ]; then
              GROUP_ID="${BASH_REMATCH[1]}"
              break
            fi
          done < pom.xml

          if [ -z "$GROUP_ID" ]; then
            echo "‚ùå Impossible d'extraire le groupId"
            exit 1
          fi

          echo "‚úÖ GroupId: $GROUP_ID"

          # Extraire la liste des modules avec grep/sed
          MODULES=$(sed -n '/<modules>/,/<\/modules>/p' pom.xml | grep "<module>" | sed 's/.*<module>\(.*\)<\/module>.*/\1/' | tr -d ' \t\r')

          if [ -z "$MODULES" ]; then
            echo "‚ö†Ô∏è  Aucun module d√©tect√©"
            echo "[]" > /tmp/modules.json
            exit 0
          fi

          echo "‚úÖ Modules trouv√©s:"
          echo "$MODULES"

          # Sauvegarder pour le prochain step
          echo "$MODULES" > /tmp/module-list.txt
          echo "$GROUP_ID" > /tmp/group-id.txt

      - name: Check deployable modules
        id: check
        run: |
          echo "üîç V√©rification des modules d√©ployables..."

          if [ ! -f /tmp/group-id.txt ]; then
            echo "[]" > /tmp/modules.json
            exit 0
          fi

          GROUP_ID=$(cat /tmp/group-id.txt)
          ENV="${{ inputs.environment }}"

          # Fonction pour extraire l'artifactId en ignorant le bloc parent
          extract_artifact_id() {
            local pom_file="$1"
            local in_parent=false
            local artifact_id=""

            while IFS= read -r line; do
              if [[ "$line" =~ \<parent\> ]]; then
                in_parent=true
              elif [[ "$line" =~ \</parent\> ]]; then
                in_parent=false
              elif [[ "$line" =~ \<artifactId\>(.*)\</artifactId\> ]] && [ "$in_parent" = false ]; then
                artifact_id="${BASH_REMATCH[1]}"
                break
              fi
            done < "$pom_file"

            echo "$artifact_id"
          }

          # Initialiser le tableau de modules
          MODULES_ARRAY="["
          FIRST=true

          # Pour chaque module
          while IFS= read -r module; do
            [ -z "$module" ] && continue

            MODULE_POM="${module}/pom.xml"

            if [ ! -f "$MODULE_POM" ]; then
              echo "‚ö†Ô∏è  Fichier non trouv√©: $MODULE_POM"
              continue
            fi

            # V√©rifier si c'est un module d√©ployable (contient spring-boot-maven-plugin)
            if grep -q "spring-boot-maven-plugin" "$MODULE_POM"; then
              echo "‚úÖ Module d√©ployable: $module"

              # Extraire l'artifactId en ignorant le bloc parent
              ARTIFACT_ID=$(extract_artifact_id "$MODULE_POM")

              # Si pas trouv√©, utiliser le nom du module
              if [ -z "$ARTIFACT_ID" ]; then
                ARTIFACT_ID="$module"
              fi

              echo "   ArtifactId: $ARTIFACT_ID"

              # Ajouter une virgule si ce n'est pas le premier
              if [ "$FIRST" = false ]; then
                MODULES_ARRAY="${MODULES_ARRAY},"
              fi
              FIRST=false

              # Construire l'entr√©e JSON (√©chapper les guillemets)
              MODULES_ARRAY="${MODULES_ARRAY}{\"name\":\"$ARTIFACT_ID\",\"artifact\":\"$GROUP_ID:$ARTIFACT_ID:jar\",\"config\":\"$GROUP_ID:$ARTIFACT_ID:zip:conf-$ENV\"}"
            else
              echo "‚è≠Ô∏è  Module non d√©ployable: $module"
            fi
          done < /tmp/module-list.txt

          MODULES_ARRAY="${MODULES_ARRAY}]"

          # Sauvegarder le JSON
          echo "$MODULES_ARRAY" > /tmp/modules.json

          echo "üìã Configuration g√©n√©r√©e:"
          cat /tmp/modules.json

      - name: Build JSON output
        id: build-json
        run: |
          if [ -n "${{ inputs.docker-modules }}" ]; then
            echo "‚úÖ Utilisation de la configuration fournie"
            echo "modules=${{ inputs.docker-modules }}" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Utilisation de la configuration auto-d√©tect√©e"

            # Compacter le JSON
            MODULES_JSON=$(cat /tmp/modules.json | jq -c .)

            echo "üìã JSON final: $MODULES_JSON"
            echo "modules=$MODULES_JSON" >> $GITHUB_OUTPUT
          fi
          echo "modules=${{ steps.final-modules.outputs.modules }}"

  build-and-publish:
    name: Build and Publish Maven Artifacts
    needs: detect-modules
    runs-on: ubuntu-latest

    outputs:
      version: ${{ steps.get-version.outputs.version }}

    permissions:
      contents: read
      packages: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up JDK ${{ inputs.java-version }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: 'temurin'
          cache: 'maven'

      - name: Get Maven version
        id: get-version
        run: |
          VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout -f ${{ inputs.maven-pom }})
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "üì¶ Maven version: $VERSION"

      - name: Configure Maven registry
        id: maven-registry
        run: |
          if [ -n "${{ inputs.maven-registry }}" ]; then
            REGISTRY="${{ inputs.maven-registry }}"
          else
            REGISTRY="https://maven.pkg.github.com/${{ github.repository }}"
          fi
          echo "url=$REGISTRY" >> $GITHUB_OUTPUT
          echo "üì¶ Maven registry: $REGISTRY"

      - name: Build with Maven
        run: |
          if [ "${{ inputs.skip-tests }}" == "true" ]; then
            mvn -B clean package -DskipTests -f ${{ inputs.maven-pom }}
          else
            mvn -B clean package -f ${{ inputs.maven-pom }}
          fi

      - name: Checkout github-actions-common for settings.xml
        uses: actions/checkout@v4
        with:
          repository: tourem/github-actions-common
          ref: main
          path: .github-actions-common

      - name: Setup Maven settings
        run: |
          mkdir -p ~/.m2
          cp .github-actions-common/settings.xml ~/.m2/settings.xml
        env:
          GITHUB_ACTOR: ${{ github.actor }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Publish to Maven registry
        run: |
          mvn -B deploy -DskipTests -f ${{ inputs.maven-pom }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifacts
        if: success()
        uses: actions/upload-artifact@v4
        with:
          name: maven-artifacts
          path: |
            **/target/*.jar
            **/target/*.zip
          retention-days: 7

  build-docker-images:
    name: Build and Push Docker Images
    needs: [detect-modules, build-and-publish]
    if: inputs.docker-build-enabled && (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest

    outputs:
      images: ${{ steps.image-list.outputs.images }}

    permissions:
      contents: read
      packages: write

    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-modules.outputs.modules) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Checkout Dockerfile repository
        uses: actions/checkout@v4
        with:
          repository: ${{ inputs.dockerfile-repo }}
          ref: ${{ inputs.dockerfile-branch }}
          path: dockerfile-repo

      - name: Display configuration
        run: |
          echo "üì¶ Module: ${{ matrix.module.name }}"
          echo "üì¶ Artifact: ${{ matrix.module.artifact }}"
          echo "üì¶ Config: ${{ matrix.module.config }}"
          echo "üì¶ Dockerfile repo: ${{ inputs.dockerfile-repo }}@${{ inputs.dockerfile-branch }}"
          echo "üì¶ Version: ${{ needs.build-and-publish.outputs.version }}"

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Configure Docker registry
        id: docker-registry
        run: |
          if [ -n "${{ inputs.docker-registry }}" ]; then
            REGISTRY="${{ inputs.docker-registry }}"
          else
            REGISTRY="ghcr.io"
          fi
          echo "url=$REGISTRY" >> $GITHUB_OUTPUT
          echo "üê≥ Docker registry: $REGISTRY"

      - name: Log in to Docker Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ steps.docker-registry.outputs.url }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ steps.docker-registry.outputs.url }}/${{ github.repository }}/${{ matrix.module.name }}
          tags: |
            type=ref,event=branch
            type=sha,prefix={{branch}}-
            type=raw,value=latest,enable={{is_default_branch}}
            type=raw,value=${{ needs.build-and-publish.outputs.version }}

      - name: Build artifact reference
        id: artifact-ref
        run: |
          ARTIFACT="${{ matrix.module.artifact }}:${{ needs.build-and-publish.outputs.version }}"
          CONFIG="${{ matrix.module.config }}:${{ needs.build-and-publish.outputs.version }}"
          echo "artifact=$ARTIFACT" >> $GITHUB_OUTPUT
          echo "config=$CONFIG" >> $GITHUB_OUTPUT
          echo "üì¶ Artifact reference: $ARTIFACT"
          echo "üì¶ Config reference: $CONFIG"

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./dockerfile-repo/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          build-args: |
            GITHUB_USER=${{ github.repository_owner }}
            GITHUB_TOKEN=${{ secrets.GITHUB_TOKEN }}
            APP_LOCATION=${{ steps.artifact-ref.outputs.artifact }}
            CONF_LOCATION=${{ steps.artifact-ref.outputs.config }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: Generate image summary
        run: |
          echo "## üê≥ Docker Image: ${{ matrix.module.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tags:**" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "${{ steps.meta.outputs.tags }}" >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Build Args:**" >> $GITHUB_STEP_SUMMARY
          echo "- APP_LOCATION: \`${{ steps.artifact-ref.outputs.artifact }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- CONF_LOCATION: \`${{ steps.artifact-ref.outputs.config }}\`" >> $GITHUB_STEP_SUMMARY

      - name: Collect image list
        id: image-list
        run: |
          IMAGE="${{ steps.docker-registry.outputs.url }}/${{ github.repository }}/${{ matrix.module.name }}:${{ needs.build-and-publish.outputs.version }}"
          echo "images=$IMAGE" >> $GITHUB_OUTPUT

  generate-deployment-descriptors:
    name: Generate Deployment Descriptors
    needs: [detect-modules, build-and-publish, build-docker-images]
    if: inputs.deployment-descriptors-enabled && (github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop') || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest

    permissions:
      contents: write

    strategy:
      matrix:
        module: ${{ fromJson(needs.detect-modules.outputs.modules) }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Generate deployment descriptor for ${{ matrix.module.name }}
        env:
          GITHUB_REPOSITORY: ${{ github.repository }}
          GITHUB_RUN_NUMBER: ${{ github.run_number }}
          GITHUB_SHA: ${{ github.sha }}
          GITHUB_REF_NAME: ${{ github.ref_name }}
        run: |
          chmod +x scripts/generate-deployment-descriptor.sh
          ./scripts/generate-deployment-descriptor.sh \
            "${{ matrix.module.name }}" \
            "${{ needs.build-and-publish.outputs.version }}" \
            "${{ inputs.environment }}" \
            "${{ inputs.docker-registry || 'ghcr.io' }}" \
            "${{ inputs.maven-registry || format('https://maven.pkg.github.com/{0}', github.repository) }}"

      - name: Upload deployment descriptors
        uses: actions/upload-artifact@v4
        with:
          name: deployment-descriptor-${{ matrix.module.name }}
          path: |
            ${{ matrix.module.name }}/deploy/deployment-descriptor-${{ matrix.module.name }}-*.json
            ${{ matrix.module.name }}/deploy/deployment-descriptor-${{ matrix.module.name }}-latest.json
          retention-days: 90

      - name: Commit and push deployment descriptors
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

          # Ajouter tous les fichiers de descripteurs (avec timestamp et latest)
          git add ${{ matrix.module.name }}/deploy/deployment-descriptor-${{ matrix.module.name }}-*.json

          if git diff --staged --quiet; then
            echo "‚úÖ Aucun changement √† committer"
          else
            TIMESTAMP=$(date +"%Y-%m-%d %H:%M:%S")
            git commit -m "chore: add deployment descriptor for ${{ matrix.module.name }} [${{ needs.build-and-publish.outputs.version }}] - ${TIMESTAMP}"

            # Retry logic pour g√©rer les pushs concurrents
            MAX_RETRIES=5
            RETRY_COUNT=0
            PUSH_SUCCESS=false

            while [ $RETRY_COUNT -lt $MAX_RETRIES ] && [ "$PUSH_SUCCESS" = "false" ]; do
              echo "üîÑ Tentative de push ($((RETRY_COUNT + 1))/$MAX_RETRIES)..."

              if git push origin HEAD:${{ github.ref_name }}; then
                PUSH_SUCCESS=true
                echo "‚úÖ Deployment descriptors committed and pushed"
              else
                echo "‚ö†Ô∏è  Push √©chou√©, pull et retry..."
                git pull --rebase origin ${{ github.ref_name }}
                RETRY_COUNT=$((RETRY_COUNT + 1))

                if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                  # Attendre un d√©lai al√©atoire entre 1 et 5 secondes pour √©viter les collisions
                  SLEEP_TIME=$((1 + RANDOM % 5))
                  echo "‚è≥ Attente de ${SLEEP_TIME}s avant retry..."
                  sleep $SLEEP_TIME
                fi
              fi
            done

            if [ "$PUSH_SUCCESS" = "false" ]; then
              echo "‚ùå √âchec du push apr√®s $MAX_RETRIES tentatives"
              exit 1
            fi
          fi

      - name: Generate deployment summary
        run: |
          echo "## üì¶ Deployment Descriptor: ${{ matrix.module.name }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Version:** ${{ needs.build-and-publish.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Environment:** ${{ inputs.environment }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Latest File:** \`${{ matrix.module.name }}/deploy/deployment-descriptor-${{ matrix.module.name }}-latest.json\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Content:**" >> $GITHUB_STEP_SUMMARY
          echo '```json' >> $GITHUB_STEP_SUMMARY
          cat ${{ matrix.module.name }}/deploy/deployment-descriptor-${{ matrix.module.name }}-latest.json >> $GITHUB_STEP_SUMMARY
          echo '```' >> $GITHUB_STEP_SUMMARY

